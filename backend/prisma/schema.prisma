// aitema|Termin - Prisma Schema (erweitert fuer Modul-System)
// Terminvergabe fuer deutsche Kommunen

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// Multi-Tenant
// ============================================================
model Tenant {
  id            String   @id @default(uuid())
  name          String
  slug          String   @unique
  ags           String?
  domain        String?
  active        Boolean  @default(true)

  // Branding
  primaryColor  String   @default("#1e3a5f")
  logoUrl       String?

  // Config
  timezone      String   @default("Europe/Berlin")
  locale        String   @default("de-DE")

  // Booking rules (Modul-System)
  slotBufferMinutes         Int  @default(0)
  minAdvanceBookingHours    Int  @default(1)
  maxAdvanceBookingDays     Int  @default(90)
  cancellationDeadlineHours Int  @default(24)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  locations     Location[]
  services      Service[]
  employees     Employee[]
  appointments  Appointment[]
  queueEntries  QueueEntry[]
  settings      TenantSettings?
  citizens      Citizen[]
  notifications Notification[]
  waitlistEntries WaitlistEntry[]

  @@index([slug])
  @@index([ags])
}

model TenantSettings {
  id                    String  @id @default(uuid())
  tenantId              String  @unique
  tenant                Tenant  @relation(fields: [tenantId], references: [id])

  maxAdvanceBookingDays Int     @default(90)
  minBookingLeadHours   Int     @default(1)
  cancelLeadHours       Int     @default(24)
  maxBookingsPerPerson  Int     @default(3)
  requireEmailVerify    Boolean @default(true)

  queueEnabled          Boolean @default(true)
  estimatedWaitDisplay  Boolean @default(true)

  bundIdEnabled         Boolean @default(false)
  bundIdClientId        String?
  bundIdRedirectUri     String?

  reminderHoursBefore   Int     @default(24)
  smsEnabled            Boolean @default(false)
  emailEnabled          Boolean @default(true)

  displayBoardEnabled   Boolean @default(true)
  callSystemEnabled     Boolean @default(false)
}

// ============================================================
// Citizen (Buerger)
// ============================================================
model Citizen {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id])

  email             String?
  phone             String?
  firstName         String?
  lastName          String?
  preferredLanguage String   @default("de")

  // DSGVO
  smsOptIn          Boolean  @default(false)
  emailOptIn        Boolean  @default(true)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  appointments      Appointment[]

  @@unique([tenantId, email])
  @@index([tenantId])
}

// ============================================================
// Locations & Services
// ============================================================
model Location {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  name        String
  address     String?
  room        String?
  postalCode  String?
  zipCode     String?
  city        String?
  phone       String?
  email       String?

  latitude    Float?
  longitude   Float?

  active      Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  counters    Counter[]
  services    LocationService[]
  appointments Appointment[]
  queueEntries QueueEntry[]
  resources   Resource[]
  openingHours OpeningHours[]
  closedDays  ClosedDay[]
  waitlistEntries WaitlistEntry[]

  @@index([tenantId])
}

model Service {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])

  name            String
  description     String?
  category        String?
  duration        Int      @default(15)  // Legacy: Minuten
  durationMinutes Int      @default(15)  // Modul-System
  bufferTime      Int      @default(5)   // Legacy
  bufferAfterMinutes Int   @default(5)   // Modul-System
  maxParallelBookings Int  @default(1)

  requiredDocs    String[]
  requiresDocuments String[] // Modul-System alias
  onlineFormUrl   String?
  fee             Float?

  active          Boolean  @default(true)
  sortOrder       Int      @default(0)

  color           String   @default("#3b82f6")
  icon            String?
  supportsVideo   Boolean  @default(false)  // D2: Video-Termin

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  locations       LocationService[]
  appointments    Appointment[]
  queueEntries    QueueEntry[]
  timeSlots       TimeSlot[]
  resourceServices ResourceService[]
  waitlistEntries WaitlistEntry[]

  @@index([tenantId, category])
}

model LocationService {
  id          String   @id @default(uuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])
  serviceId   String
  service     Service  @relation(fields: [serviceId], references: [id])

  active      Boolean  @default(true)

  @@unique([locationId, serviceId])
}

// ============================================================
// Resources (Raeume/Schalter fuer Modul-System)
// ============================================================
model Resource {
  id          String   @id @default(uuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])

  name        String
  active      Boolean  @default(true)

  timeSlots   TimeSlot[]
  resourceServices ResourceService[]

  @@index([locationId])
}

model ResourceService {
  id         String   @id @default(uuid())
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id])
  serviceId  String
  service    Service  @relation(fields: [serviceId], references: [id])

  @@unique([resourceId, serviceId])
}

// ============================================================
// Time Slots (Modul-System)
// ============================================================
model TimeSlot {
  id          String   @id @default(uuid())
  resourceId  String
  resource    Resource @relation(fields: [resourceId], references: [id])
  serviceId   String
  service     Service  @relation(fields: [serviceId], references: [id])

  date        DateTime @db.Date
  startTime   DateTime
  endTime     DateTime

  status      TimeSlotStatus @default(AVAILABLE)

  appointments Appointment[]

  @@index([resourceId, date])
  @@index([serviceId, date])
}

enum TimeSlotStatus {
  AVAILABLE
  RESERVED
  BOOKED
  BLOCKED
}

// ============================================================
// Employees & Counters
// ============================================================
model Employee {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  name        String
  email       String
  role        EmployeeRole @default(SACHBEARBEITER)
  active      Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  counterAssignments CounterAssignment[]
  appointments       Appointment[]

  @@unique([tenantId, email])
  @@index([tenantId])
}

enum EmployeeRole {
  ADMIN
  TEAMLEITER
  SACHBEARBEITER
  EMPFANG
}

model Counter {
  id          String   @id @default(uuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])

  number      Int
  name        String?
  active      Boolean  @default(true)

  assignments CounterAssignment[]
  queueEntries QueueEntry[]

  @@unique([locationId, number])
}

model CounterAssignment {
  id          String   @id @default(uuid())
  counterId   String
  counter     Counter  @relation(fields: [counterId], references: [id])
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id])

  date        DateTime @db.Date
  startTime   DateTime
  endTime     DateTime

  @@index([counterId, date])
  @@index([employeeId, date])
}

// ============================================================
// Appointments (Legacy + Modul-System Felder)
// ============================================================
model Appointment {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  locationId      String
  location        Location @relation(fields: [locationId], references: [id])
  serviceId       String
  service         Service  @relation(fields: [serviceId], references: [id])
  employeeId      String?
  employee        Employee? @relation(fields: [employeeId], references: [id])

  // Citizen (Modul-System)
  citizenId       String?
  citizen         Citizen? @relation(fields: [citizenId], references: [id])

  // Resource + TimeSlot (Modul-System)
  resourceId      String?
  timeSlotId      String?
  timeSlot        TimeSlot? @relation(fields: [timeSlotId], references: [id])

  // Time (Legacy)
  date            DateTime? @db.Date
  startTime       DateTime?
  endTime         DateTime?

  // Time (Modul-System)
  scheduledStart  DateTime?
  scheduledEnd    DateTime?

  // Citizen info
  citizenName     String
  citizenEmail    String?
  citizenPhone    String?

  // Status
  status          AppointmentStatus @default(BOOKED)

  // Source
  source          String   @default("ONLINE")
  notes           String?

  // Booking reference (Legacy + Modul-System)
  bookingRef      String?  @unique
  bookingCode     String?  @unique

  confirmationSent  Boolean @default(false)
  reminderSent      Boolean @default(false)
  reminder24hSent   Boolean @default(false)
  reminder1hSent    Boolean @default(false)

  // Check-in
  checkedInAt     DateTime?
  calledAt        DateTime?
  completedAt     DateTime?
  cancelledAt     DateTime?
  cancelReason    String?

  // T3: SMS Opt-In
  smsOptIn        Boolean  @default(false)

  // D2: Video-Termin
  appointmentType String   @default("inperson") // inperson | video
  jitsiRoomId     String?

  // Queue (optional)
  queueEntry      QueueEntry?

  // T2: QR-Code fuer Check-in
  qrCodeDataUrl   String?

  // BundID
  bundIdVerified  Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId, scheduledStart])
  @@index([locationId, scheduledStart])
  @@index([status])
  @@index([bookingCode])
  @@index([bookingRef])
}

enum AppointmentStatus {
  BOOKED
  CONFIRMED
  CHECKED_IN
  CALLED
  IN_PROGRESS
  COMPLETED
  NO_SHOW
  CANCELLED
}

// ============================================================
// Queue Management (Wartenummern)
// ============================================================
model QueueEntry {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])
  serviceId   String
  service     Service  @relation(fields: [serviceId], references: [id])
  counterId   String?
  counter     Counter? @relation(fields: [counterId], references: [id])

  // Modul-System (appointment optionale Referenz)
  appointmentId String? @unique
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])

  ticketNumber  String
  position      Int?
  citizenName   String?

  status       QueueStatus @default(WAITING)
  priority     Int         @default(0)

  createdAt    DateTime @default(now())
  calledAt     DateTime?
  startedAt    DateTime?
  completedAt  DateTime?

  estimatedWait         Int?
  estimatedWaitMinutes  Int?

  @@index([tenantId, locationId, status])
  @@index([ticketNumber])
}

enum QueueStatus {
  WAITING
  CALLED
  IN_PROGRESS
  COMPLETED
  NO_SHOW
  CANCELLED
}

// ============================================================
// Availability / Opening Hours
// ============================================================
model OpeningHours {
  id          String   @id @default(uuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])

  dayOfWeek   Int
  openTime    String
  closeTime   String
  breakStart  String?
  breakEnd    String?

  specificDate DateTime? @db.Date
  closed       Boolean  @default(false)
  note         String?
  active       Boolean  @default(true)

  @@index([locationId, dayOfWeek])
}

// ============================================================
// Closed Days (Feiertage/Schliessungen) - Modul-System
// ============================================================
model ClosedDay {
  id          String   @id @default(uuid())
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])

  date        DateTime @db.Date
  recurring   Boolean  @default(false)
  note        String?

  @@index([locationId, date])
}

// ============================================================
// Notifications Log
// ============================================================
model Notification {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])

  type          String   // BOOKING_CONFIRMATION, REMINDER, CANCELLATION etc.
  channel       String   // EMAIL, SMS, PUSH

  recipient     String
  subject       String?
  body          String?

  status        String   @default("PENDING")
  referenceType String?
  referenceId   String?
  error         String?
  sentAt        DateTime?

  createdAt     DateTime @default(now())

  @@index([tenantId])
  @@index([referenceId])
}

// ============================================================
// D1: Warteliste (Automatische Warteliste bei Stornierungen)
// ============================================================
model WaitlistEntry {
  id            String    @id @default(cuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  serviceId     String
  service       Service   @relation(fields: [serviceId], references: [id])
  locationId    String?
  location      Location? @relation(fields: [locationId], references: [id])

  name          String
  phone         String
  email         String?

  preferredDates Json?    // Array: [{from: ISO, to: ISO}]

  status        WaitlistStatus @default(WAITING)
  token         String    @unique @default(cuid())

  offeredSlotStart DateTime?
  offeredSlotEnd   DateTime?
  offeredAt        DateTime?
  expiresAt        DateTime?

  confirmedAt   DateTime?
  declinedAt    DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([tenantId, serviceId, status])
  @@index([token])
  @@index([expiresAt])
}

enum WaitlistStatus {
  WAITING
  OFFERED
  CONFIRMED
  DECLINED
  EXPIRED
  CANCELLED
}
